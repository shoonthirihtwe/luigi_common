<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jp.co.ichain.luigi2.mapper.NotificationMapper">
	<insert id="insertNotification" parameterType="hashmap">
		INSERT INTO notifications (
			tenant_id,
			notification_date,
			contract_no,
			contract_branch_no,
			template_number,
		    notification_implementation,
		    comment,
		    data,
		    sendee,
		    notification_method,
		    email,
		    error_flag,
		  	created_by
		) SELECT distinct
			#{tenantId},
			#{notificationDate},
			#{contractNo},
			co.contract_branch_no,
			#{templateNumber},
			'0',
			#{comment},
			'${data}',
			<if test ="sendee != null">#{sendee},</if>
			<if test ="sendee == null">CASE cu.corporate_individual_flag
				when '1' then concat(cui.name_knj_sei,' ',cui.name_knj_mei)
				when '2' then cuc.corp_name_official
				ELSE null END,</if>
			#{notificationMethod},
			<if test ="email != null">#{email},</if>
			<if test ="email == null">CASE cu.corporate_individual_flag 
				when '1' then cui.email
				when '2' then cuc.contact_email
				ELSE null END,</if>
			IFNULL(#{errorFlag},0),
			#{updatedBy}
		FROM (SELECT contractor_customer_id
			,max(contract_branch_no) as contract_branch_no
			FROM contracts
			WHERE tenant_id=#{tenantId} AND contract_no='${contractNo}'
			GROUP BY tenant_id, contract_no, contractor_customer_id) co LEFT OUTER JOIN customers cu
			ON co.contractor_customer_id = cu.customer_id
			LEFT OUTER JOIN customers_individual cui
				ON co.contractor_customer_id = cui.customer_id AND cu.corporate_individual_flag='1'
			LEFT OUTER JOIN customers_corporate cuc
				ON co.contractor_customer_id = cuc.customer_id AND cu.corporate_individual_flag='2'
		ORDER BY co.contract_branch_no DESC
	</insert>
</mapper>
