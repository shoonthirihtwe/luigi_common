<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jp.co.ichain.luigi2.mapper.NotificationMapper">
	<insert id="insertNotification" parameterType="hashmap">
		INSERT INTO notifications (
			tenant_id,
			notification_date,
			contract_no,
			contract_branch_no,
			template_number,
		    notification_implementation,
		    comment,
		    data,
		    sendee,
		    notification_method,
		    email,
		    error_flag,
		  	created_by
		) SELECT distinct
			#{tenantId},
			#{notificationDate},
			#{contractNo},
			max(co.contract_branch_no),
			#{templateNumber},
			'0',
			#{comment},
			'${data}',
			<if test ="sendee != null">#{sendee},</if>
			<if test ="sendee == null">CASE 
				when cui.id is not null then concat(cui.name_knj_sei,' ',cui.name_knj_mei)
				when cuc.id is not null then cuc.corp_name_official
				ELSE null END,</if>
			#{notificationMethod},
			<if test ="email != null">#{email},</if>
			<if test ="email == null">CASE when cui.id is not null then cui.email
				when cuc.id is not null then cuc.contact_email
				ELSE null END,</if>
			IFNULL(#{errorFlag},0),
			#{updatedBy}
		FROM contracts co LEFT OUTER JOIN customers cu
				ON co.contractor_customer_id = cu.customer_id
			LEFT OUTER JOIN customers_individual cui
				ON co.contractor_customer_id = cui.customer_id AND cui.id is not null
			LEFT OUTER JOIN customers_corporate cuc
				ON co.contractor_customer_id = cuc.customer_id AND cuc.id is not null
		WHERE co.contract_no='${contractNo}' ORDER BY co.contract_branch_no AND (cui.id is not null OR cuc.id is not null) DESC LIMIT 1
	</insert>
</mapper>
